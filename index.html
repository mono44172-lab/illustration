<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>おたよりイラスト・自動ギャラリー</title>
<meta name="description" content="Twitch配信でいただいたおたよりイラストを自動で一覧表示（meta.json不要）" />
<style>
  :root{
    --bg:#0b0b10; --fg:#fff; --muted:#a7a7b3; --accent:#ff2c83;
    --card:#14141a; --shadow:0 6px 30px rgba(0,0,0,.35);
    --max:1400px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif}
  a{color:inherit;text-decoration:none}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,16,.95),rgba(11,11,16,.75) 60%,transparent);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
  .inner{max-width:var(--max);margin:auto;padding:14px 18px}
  .title{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
  .title h1{margin:0;font-size:clamp(18px,2.6vw,26px);letter-spacing:.02em}
  .title .sub{color:var(--muted);font-size:clamp(12px,1.8vw,14px)}
  .bar{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .pill{padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;color:var(--muted);font-size:13px}
  .pill strong{color:var(--fg)}
  main{max-width:var(--max);margin:8px auto 80px;padding:0 12px}
  .grid{column-width:280px;column-gap:12px}
  @media (max-width:640px){ .grid{column-width:180px} }
  figure.item{break-inside:avoid;background:var(--card);border-radius:16px;box-shadow:var(--shadow);margin:0 0 12px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
  .thumb{display:block;width:100%;height:auto;background:#000;aspect-ratio:4/3;object-fit:cover}
  figcaption{padding:10px 12px 12px}
  .cap-title{font-weight:700;font-size:14px}
  .cap-meta{color:var(--muted);font-size:12px;margin-top:2px}
  .lightbox{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);z-index:50}
  .lightbox.open{display:grid}
  .lb-img{max-width:95vw;max-height:90vh;border-radius:14px;box-shadow:var(--shadow)}
  .lb-cap{color:#ddd;margin-top:10px;text-align:center;font-size:14px}
  .lb-x{position:absolute;top:12px;right:12px;border:0;border-radius:10px;background:rgba(255,255,255,.1);color:#fff;padding:8px 10px;font-size:14px;cursor:pointer}
  footer{max-width:var(--max);margin:30px auto 50px;color:var(--muted);font-size:12px;padding:0 12px}
  .muted{color:var(--muted)}
  .err{color:#ff9aa8}
</style>
</head>
<body>
  <header>
    <div class="inner">
      <div class="title">
        <h1>おたよりイラスト・自動ギャラリー</h1>
        <span class="sub">images/ に入れた順（ファイル名順）で自動表示</span>
      </div>
      <div class="bar">
        <span id="count" class="pill">読み込み中…</span>
        <span class="pill">更新方法: <strong>images/ に追加 or 削除 → コミット</strong></span>
        <button id="toggleOrder" class="pill" title="表示順を切替">並び: 新しい順</button>
      </div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid" aria-live="polite"></div>
    <p id="error" class="inner err" style="display:none"></p>
  </main>

  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="拡大表示">
    <button class="lb-x" id="lbClose" aria-label="閉じる">✕</button>
    <div>
      <img id="lbImg" class="lb-img" alt="">
      <div id="lbCap" class="lb-cap"></div>
    </div>
  </div>

  <footer>
    <p class="muted">※ 画像は GitHub Pages から直接配信。著作権は各作者に帰属。削除依頼はSNS/DMでご連絡ください。</p>
  </footer>

<script>
/** ========== 設定（ここだけ書き換え） ========== */
const GH_CONFIG = {
  owner: "YOUR_GITHUB_USERNAME", // 例: mono44172
  repo:  "YOUR_REPO_NAME",       // 例: otayori-gallery
  branch:"main",                  // 例: main（デフォルトブランチ名）
  imagesDir: "images/"            // 末尾スラッシュ必須。サブフォルダOK: "assets/otayori/"
};
/** =============================================== */

// Git Trees API（1回のAPIで全ファイル取得）
const TREE_API = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/git/trees/${encodeURIComponent(GH_CONFIG.branch)}?recursive=1`;
const RAW_BASE  = `https://raw.githubusercontent.com/${GH_CONFIG.owner}/${GH_CONFIG.repo}/${GH_CONFIG.branch}/`;

const IMG_EXT = [".jpg",".jpeg",".png",".webp",".gif",".avif",".bmp"];
const isImage = (p)=> IMG_EXT.some(ext=> p.toLowerCase().endsWith(ext));

const grid = document.getElementById('grid');
const countEl = document.getElementById('count');
const errEl = document.getElementById('error');

const natCmp = (a,b) => a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'});

let orderDesc = true; // true: 新しい順（名前降順とみなす）
document.getElementById('toggleOrder').addEventListener('click', ()=>{
  orderDesc = !orderDesc;
  render(currentList);
  document.getElementById('toggleOrder').textContent = '並び: ' + (orderDesc ? '新しい順' : '古い順');
});

let currentList = [];

(async function main(){
  try{
    const res = await fetch(TREE_API, {headers: {'Accept':'application/vnd.github+json'}});
    if(!res.ok) throw new Error(`GitHub API error ${res.status}`);
    const json = await res.json();
    // 画像のみ抽出（imagesDir配下）
    const files = (json.tree||[])
      .filter(node => node.type === 'blob' && node.path.startsWith(GH_CONFIG.imagesDir) && isImage(node.path))
      .map(node => ({
        path: node.path,
        name: node.path.split('/').pop(),
        url: RAW_BASE + node.path
      }));

    if(files.length === 0){
      countEl.textContent = '掲載数: 0点';
      grid.innerHTML = `<p class="inner muted">images/ フォルダに画像を追加してコミットすると自動表示されます。</p>`;
      return;
    }

    currentList = files;
    render(files);
  }catch(err){
    console.error(err);
    errEl.style.display = 'block';
    errEl.textContent = '画像一覧の取得に失敗しました。設定（GH_CONFIG）が正しいか確認してください。';
    countEl.textContent = '読み込み失敗';
  }
})();

function render(list){
  const sorted = [...list].sort((a,b)=> orderDesc ? natCmp(b.name,a.name) : natCmp(a.name,b.name));
  countEl.textContent = `掲載数: ${sorted.length}点`;
  grid.innerHTML = sorted.map(f => `
    <figure class="item">
      <img class="thumb" loading="lazy" decoding="async" src="${f.url}" alt="${f.name}" />
      <figcaption>
        <div class="cap-title">${escapeHtml(stripExt(f.name))}</div>
        <div class="cap-meta">${escapeHtml(f.path)}</div>
      </figcaption>
    </figure>
  `).join('');
}

// クリックで拡大
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lbImg');
const lbCap = document.getElementById('lbCap');
const lbClose = document.getElementById('lbClose');

grid.addEventListener('click', (e)=>{
  const img = e.target.closest('.thumb');
  if(!img) return;
  lbImg.src = img.src;
  const fig = e.target.closest('figure');
  lbCap.innerHTML = fig.querySelector('figcaption').innerHTML;
  lb.classList.add('open');
});
lb.addEventListener('click', (e)=>{
  if(e.target.id==='lightbox') lb.classList.remove('open');
});
lbClose.addEventListener('click', ()=> lb.classList.remove('open'));
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') lb.classList.remove('open') });

// Util
function stripExt(name){ const i = name.lastIndexOf('.'); return i>0 ? name.slice(0,i) : name; }
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
</script>
</body>
</html>
